<script type="text/ng-template" id="nodes_renderer.html">
    <div ui-tree-handle class="tree-node tree-node-content overflow-ellipsis" style="max-width: 100%">
        <div class="pull-left" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">
            <a ng-if="node.type && (node.template.message_blocks.length || node.message_blocks.length)" class="btn btn-success btn-xs m-r-5" ng-if="$ctrl.hasChildren(node)" data-nodrag ng-click="$ctrl.toggle(this)">
                <i class="fa" ng-class="{'fa-arrow-right': collapsed,'fa-arrow-down': !collapsed}"></i>
            </a>
            <span ng-if="!node.type"><em>[Subtree]</em> {{node.name}}</span>
            <span ng-if="node.type">
                <span ng-if="node.type == 'text'">
                    <em>[Text]</em>
                    <em ng-if="!node.text" class="text-hint">Empty</em>
                    <span ng-if="node.text">{{ node.text}}</span>
                </span>
                <em ng-if="node.type == 'image'">[Image]</em>
                <span ng-if="node.type == 'button'">
                    <em>[Button]</em>
                    {{ node.title }}
                </span>
                <em ng-if="node.type == 'card_container'">[Card Container]</em>
                <span ng-if="node.type == 'card'">
                    <em>[Card]</em>
                    <span ng-if="node.title">{{ node.title }}</span>
                    <em ng-if="!node.title">Empty</em>
                </span>
            </span>
        </div>
        <div class="tree-actions" data-nodrag>
            <a class="btn btn-info btn-xs" ng-click="$ctrl.duplicate(node)" bs-tooltip data-original-title="Duplicate" ng-if="node.type">
                <i class="fa fa-clone"></i>
            </a>
            <a class="btn btn-success btn-xs" ng-click="$ctrl.openSubtreeModal(node)" ng-if="node.type == 'button' && node.template.message_blocks.length && !node.template.is_explicit" bs-tooltip data-original-title="Save subtree separately.">
                <i class="fa fa-save"></i>
            </a>
            <a class="btn btn-primary btn-xs" ng-click="$ctrl.edit(node)" ng-if="node.type == 'button'">
                <i class="fa fa-plus"></i>
            </a>
            <a class="btn btn-warning btn-xs" ng-click="$ctrl.editButton(node)" ng-if="node.type == 'button'">
                <i class="fa fa-pencil"></i>
            </a>
            <a class="btn btn-warning btn-xs" ng-click="$ctrl.editCard(node)" ng-if="node.type == 'card'">
                <i class="fa fa-pencil"></i>
            </a>
            <a class="btn btn-warning btn-xs" ng-click="$ctrl.edit(node)" ng-if="node.type && node.type != 'card' && node.type != 'button'">
                <i class="fa fa-pencil"></i>
            </a>
            <a target="_blank" ui-sref="dashboard.build.tree.edit({templateId: node.id})" class="btn btn-warning btn-xs" ng-if="!node.type">
                <i class="fa fa-pencil"></i>
            </a>
            <a class="btn btn-danger btn-xs" ng-click="$ctrl.remove(this)">
                <i class="fa fa-remove"></i>
            </a>
        </div>
    </div>
    <ol ui-tree-nodes="" ng-if="node.type =='button' && node.template.is_explicit" ng-model="$ctrl.tempNodes[node.$$hashKey]" ng-class="{hidden: collapsed}">
        <li ng-repeat="node in $ctrl.tempNodes[node.$$hashKey]" ui-tree-node ng-include="'nodes_renderer.html'"></li>
    </ol>
    <ol ui-tree-nodes="" ng-if="node.type =='button' && !node.template.is_explicit" ng-init="node.template = node.template || {name: 'Subtree', message_blocks: []}" ng-model="node.template.message_blocks" ng-class="{hidden: collapsed}">
        <li ng-repeat="node in node.template.message_blocks" ui-tree-node ng-include="'nodes_renderer.html'"></li>
    </ol>
    <ol ui-tree-nodes="" ng-if="node.type && node.type != 'button' " ng-model="node.message_blocks" ng-class="{hidden: collapsed}">
        <li ng-repeat="node in node.message_blocks" ui-tree-node ng-include="'nodes_renderer.html'"></li>
    </ol>
</script>


<div class="row">
    <div class="col-xs-6">
        <div class="row">
            <div class="col-xs-6">
                <div pg-form-group="" class="form-group form-group-default">
                    <label>Tree Name</label>
                    <input type="text" ng-model="$ctrl.tree.name" class="form-control">
                </div>
            </div>
            <div class="col-xs-6">
                <button ng-click="$ctrl.save()" class="pull-right btn btn-sm btn-success">Save</button>
                <button ng-click="$ctrl.collapseAll()" class="pull-right btn btn-sm btn-default m-r-5" bs-tooltip data-original-title="Collapse All"><i class="fa fa-minus"></i></button>
                <button ng-click="$ctrl.expandAll()" class="pull-right btn btn-sm btn-default m-r-5" bs-tooltip data-original-title="Expand All"><i class="fa fa-plus"></i></button>
                <button ng-click="$ctrl.edit($ctrl.tree)" class="pull-right btn btn-sm btn-primary m-r-5" ng-if="$ctrl.active != $ctrl.tree">Add Node</button>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <div ui-tree="$ctrl.treeOptions" id="tree-root" data-drag-delay="100">
                    <ol ui-tree-nodes ng-model="$ctrl.tree.message_blocks">
                        <li ng-repeat="node in $ctrl.tree.message_blocks" ui-tree-node ng-include="'nodes_renderer.html'"></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xs-6">
        <text-block ng-if="$ctrl.active.type == 'text'" message-block="$ctrl.active"></text-block>
        <image-block ng-if="$ctrl.active.type == 'image'" message-block="$ctrl.active"></image-block>
        <card-container-block ng-if="$ctrl.active.type == 'card_container'" message-block="$ctrl.active"></card-container-block>
        <div ng-if="$ctrl.active && (!$ctrl.active.type || $ctrl.active.type == 'button')">
            <div class="text-center">
                <h4>Select New Message Block Type</h4>
                <button class="btn btn-primary bg-primary-dark m-r-10 m-b-10" ng-click="$ctrl.addBlock('text')" ng-if="">
                    + Send Message Template
                </button>
                <button class="btn btn-primary bg-primary-dark m-r-10 m-b-10" ng-click="$ctrl.addBlock('text')">
                    + Add Text
                </button>
                <button class="btn btn-primary bg-primary-dark m-r-10 m-b-10" ng-click="$ctrl.addBlock('image')">
                    + Add Image
                </button>
                <button class="btn btn-primary bg-primary-dark m-r-10 m-b-10" ng-click="$ctrl.addBlock('card_container')">
                    + Add Card Container
                </button>
            </div>
            <div ng-if="$ctrl.active.type == 'button' && $ctrl.trees.length">
                <h4 class="text-center">[Or] Send another message tree</h4>
                <ui-select ng-model="$ctrl.treeToAdd" theme="select2" style="width:100%">
                    <ui-select-match placeholder="Select/Deselect Templates">{{ $select.selected.name }}</ui-select-match>
                    <ui-select-choices repeat="tree in $ctrl.trees | propsFilter: {name: $select.search }">
                        <div ng-bind-html="tree.name | highlight: $select.search"></div>
                    </ui-select-choices>
                </ui-select>
                <div class="alert alert-warning" ng-if="$ctrl.active.template.message_blocks.length">
                    <strong>Attention!</strong> Adding a template will replace the current template/message block(s) associated with this button.
                </div>
                <div class="text-center m-t-10">
                    <button class="btn btn-primary" ng-disabled="!$ctrl.treeToAdd" ng-click="$ctrl.addTree()">Add Template</button>
                </div>
            </div>
        </div>
    </div>
</div>
